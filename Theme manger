local httpService = game:GetService('HttpService')
local ThemeManager = {}

do
    ThemeManager.Folder = 'LinoriaLibSettings'
    ThemeManager.Library = nil

    ThemeManager.BuiltInThemes = {
        ['Default']   = { 1, httpService:JSONDecode('{"FontColor":"ffffff","MainColor":"1c1c1c","AccentColor":"0055ff","BackgroundColor":"141414","OutlineColor":"323232"}') },
        ['Pink']      = { 2, httpService:JSONDecode('{"FontColor":"000000","MainColor":"ffd1dc","AccentColor":"ff69b4","BackgroundColor":"ffeaf0","OutlineColor":"e75480"}') },
        ['Fatality']  = { 3, httpService:JSONDecode('{"FontColor":"ffffff","MainColor":"1e1842","AccentColor":"c50754","BackgroundColor":"191335","OutlineColor":"3c355d"}') },
        ['Jester']    = { 4, httpService:JSONDecode('{"FontColor":"ffffff","MainColor":"242424","AccentColor":"db4467","BackgroundColor":"1c1c1c","OutlineColor":"373737"}') },
        ['Mint']      = { 5, httpService:JSONDecode('{"FontColor":"ffffff","MainColor":"242424","AccentColor":"3db488","BackgroundColor":"1c1c1c","OutlineColor":"373737"}') },
        ['DarkPink']  = { 6, httpService:JSONDecode('{"FontColor":"ffffff","MainColor":"880e4f","AccentColor":"ad1457","BackgroundColor":"4a0033","OutlineColor":"560027"}') },
        ['Ubuntu']    = { 7, httpService:JSONDecode('{"FontColor":"ffffff","MainColor":"3e3e3e","AccentColor":"e2581e","BackgroundColor":"323232","OutlineColor":"191919"}') },
        ['Quartz']    = { 8, httpService:JSONDecode('{"FontColor":"ffffff","MainColor":"232330","AccentColor":"426e87","BackgroundColor":"1d1b26","OutlineColor":"27232f"}') },
    }

    function ThemeManager:ApplyTheme(theme)
        local customTheme = self:GetCustomTheme(theme)
        local data = customTheme or self.BuiltInThemes[theme]
        if not data then return end

        local scheme = data[2]
        for key, hex in pairs(scheme) do
            self.Library[key] = Color3.fromHex(hex)
            if Options[key] then
                Options[key]:SetValueRGB(Color3.fromHex(hex))
            end
        end

        self:ThemeUpdate()
    end

    function ThemeManager:ThemeUpdate()
        for _, k in ipairs{"FontColor","MainColor","AccentColor","BackgroundColor","OutlineColor"} do
            if Options and Options[k] then
                self.Library[k] = Options[k].Value
            end
        end
        self.Library.AccentColorDark = self.Library:GetDarkerColor(self.Library.AccentColor)
        self.Library:UpdateColorsUsingRegistry()
    end

    function ThemeManager:LoadDefault()
        local theme = 'Default'
        local path = self.Folder..'/themes/default.txt'
        if isfile(path) then
            local saved = readfile(path)
            if self.BuiltInThemes[saved] then theme = saved
            elseif self:GetCustomTheme(saved) then theme = saved end
        end
        Options.ThemeManager_ThemeList:SetValue(theme)
    end

    function ThemeManager:SaveDefault(theme)
        writefile(self.Folder..'/themes/default.txt', theme)
    end

    function ThemeManager:CreateThemeManager(box)
        box:AddLabel('Background color'):AddColorPicker('BackgroundColor',{Default=self.Library.BackgroundColor})
        box:AddLabel('Main color')      :AddColorPicker('MainColor',{Default=self.Library.MainColor})
        box:AddLabel('Accent color')    :AddColorPicker('AccentColor',{Default=self.Library.AccentColor})
        box:AddLabel('Outline color')   :AddColorPicker('OutlineColor',{Default=self.Library.OutlineColor})
        box:AddLabel('Font color')      :AddColorPicker('FontColor',{Default=self.Library.FontColor})

        local names = {}
        for name in pairs(self.BuiltInThemes) do table.insert(names,name) end
        table.sort(names, function(a,b) return self.BuiltInThemes[a][1] < self.BuiltInThemes[b][1] end)

        box:AddDivider()
        box:AddDropdown('ThemeManager_ThemeList',{Text='Theme list',Values=names,Default=1})
        box:AddButton('Set as default',function()
            self:SaveDefault(Options.ThemeManager_ThemeList.Value)
            self.Library:Notify(("Default ➔ %q"):format(Options.ThemeManager_ThemeList.Value))
        end)

        Options.ThemeManager_ThemeList:OnChanged(function()
            self:ApplyTheme(Options.ThemeManager_ThemeList.Value)
        end)

        box:AddDivider()
        box:AddInput('ThemeManager_CustomThemeName',{Text='Custom theme name'})
        box:AddDropdown('ThemeManager_CustomThemeList',{Text='Custom themes',Values=self:ReloadCustomThemes(),AllowNull=true,Default=1})

        box:AddButton('Save theme',function()
            self:SaveCustomTheme(Options.ThemeManager_CustomThemeName.Value)
            Options.ThemeManager_CustomThemeList:SetValues(self:ReloadCustomThemes())
            Options.ThemeManager_CustomThemeList:SetValue(nil)
        end):AddButton('Load theme',function()
            self:ApplyTheme(Options.ThemeManager_CustomThemeList.Value)
        end)

        box:AddButton('Refresh list',function()
            Options.ThemeManager_CustomThemeList:SetValues(self:ReloadCustomThemes())
            Options.ThemeManager_CustomThemeList:SetValue(nil)
        end)

        box:AddButton('Set as default',function()
            local sel = Options.ThemeManager_CustomThemeList.Value
            if sel and sel ~= '' then
                self:SaveDefault(sel)
                self.Library:Notify(("Default ➔ %q"):format(sel))
            end
        end)

        self:LoadDefault()
        for _,k in ipairs{"BackgroundColor","MainColor","AccentColor","OutlineColor","FontColor"} do
            Options[k]:OnChanged(function() self:ThemeUpdate() end)
        end
    end

    function ThemeManager:GetCustomTheme(name)
        local f = self.Folder..'/themes/'..name..'.json'
        if not isfile(f) then return nil end
        local ok,data = pcall(httpService.JSONDecode,httpService,readfile(f))
        return ok and data or nil
    end

    function ThemeManager:SaveCustomTheme(name)
        if name:match'^%s*$' then return self.Library:Notify('Invalid name',3) end
        local t = {}
        for _,k in ipairs{"FontColor","MainColor","AccentColor","BackgroundColor","OutlineColor"} do
            t[k] = Options[k].Value:ToHex()
        end
        writefile(self.Folder..'/themes/'..name..'.json', httpService:JSONEncode(t))
    end

    function ThemeManager:ReloadCustomThemes()
        local out = {}
        for _,f in ipairs(listfiles(self.Folder..'/themes')) do
            if f:sub(-5)=='.json' then
                out[#out+1] = f:match'([^\\/]+)%.json$'
            end
        end
        return out
    end

    function ThemeManager:SetLibrary(lib) self.Library = lib end

    function ThemeManager:BuildFolderTree()
        local paths, parts = {}, self.Folder:split('/')
        for i=1,#parts do paths[i] = table.concat(parts,'/',1,i) end
        paths[#paths+1] = self.Folder..'/themes'; paths[#paths+1] = self.Folder..'/settings'
        for _,p in ipairs(paths) do if not isfolder(p) then makefolder(p) end end
    end

    function ThemeManager:SetFolder(folder)
        self.Folder = folder
        self:BuildFolderTree()
    end

    function ThemeManager:CreateGroupBox(tab)
        assert(self.Library,'Need to set library')
        return tab:AddLeftGroupbox('Themes')
    end

    function ThemeManager:ApplyToTab(tab)
        self:CreateThemeManager(self:CreateGroupBox(tab))
    end

    function ThemeManager:ApplyToGroupbox(box)
        self:CreateThemeManager(box)
    end

    ThemeManager:BuildFolderTree()
end

return ThemeManager
